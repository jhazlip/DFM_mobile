<!DOCTYPE html>
<html>
	<head>
		<meta http-equiv="content-type" content="text/html; charset=UTF-8">
		<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=0, minimum-scale=1.0, maximum-scale=1.0">
		<meta name="apple-mobile-web-app-capable" content="yes">
		<meta name="apple-mobile-web-app-status-bar-style" content="black">
		
		<script type='text/javascript'>
			(function() {
				var useSSL = 'https:' == document.location.protocol;
				var src = (useSSL ? 'https:' : 'http:') + '//www.googletagservices.com/tag/js/gpt_mobile.js';
				document.write('<scr' + 'ipt src="' + src + '"></scr' + 'ipt>');
			})();
		</script>
		
		<link rel="stylesheet" type="text/css" media="all" href="css/style.css">										<!-- dfm_mobile css -->
		
		<script type="text/javascript" src="js/dfm_mobile.js"></script>
		<script src="js/JSXCompressor/jsxcompressor.min.js" type="text/javascript"></script>		<!-- uncompresses json - wont need once NGPS feed done -->
		<script src="http://sandbox.dailyme.com/rmv2/js/recommender.js"></script>										<!-- newstogram -->
		
		<script>
		//content:"";
			document.addEventListener('DOMContentLoaded', function (e) { pageloaded(); }, false);
			var xtesting = 0;
			var xInterface;
			
			var xFeedList = new Array();			//property list of all sections and their feeds
			var activeSection 	= 0;				//the current section number (in xFeedList array) - pointer
			var StoryList = new Array();			//array with all current section stories
			var activeStory		= 0;				//the current story   number (in StoryList array) - pointer DO WE NEED????
			var StoryContent = new Array();			//array with all current stories content
			var propertyTitle = '';
			var propertySplashImage = '';
			var backgroundsplash = '';
			var AppleAppID;
			var topDomain, basedomain;
			
			var fetchJsonLocally = 0;				//we have two sources to pull our XML from, 1= convergence tool (in-house), 0= yahoo yql service
			
			var propertyDataObject = new Array();
			var contentDataObject = new Array();
			
			//------------these variables will need to be moved to the property.js eventually
			var adunit = '/8013/digital.first.media.test.site/Mobile';
			var ad1, ad2;
			
			//-------on init of page, prepare ad units for later rendering
			googletag.cmd.push(function() {
				//----all ads here
				ad1 = googletag.defineSlot( adunit, [300, 50],  'story_ad_top').addService(googletag.pubads());
				ad2 = googletag.defineSlot( adunit, [300, 250], 'story_ad_bottom').addService(googletag.pubads());
				
				googletag.pubads().enableAsyncRendering();
				googletag.pubads().disableInitialLoad();		//turns off rendering on initial load
				googletag.enableServices();
			});
			
			function pageloaded() {
				//-------everything has loaded, now we need to get property specific js and css before we do anything
				//			yeah not truly efficient, this process can be cleaned up i think for speed but for now, it works
				
				//http://delivery.digitalfirstmedia.com/ConvergencePublisher/?format=json&uri=http://extras.denverpost.com/media/MRSS/Breaking_News_230605.xml&paramname=site&param=Denver+Post
				//---for testing loading of external js along with code at bottom of universal.js
				//fetchExternalJSON('http://extras.denverpost.com/media/MRSS/Breaking_News_230605.xml');
				//return 0;
				//setTimeout(function() { fetchExternalJSON('http://extras.denverpost.com/media/MRSS/Breaking_News_230605.xml'); }, 4000);
				
				
				//---------------------------------------------load property specific external files
				//topDomain = get_top_domain( window.location.href );
				//if ( (topDomain == 'localhost') || (topDomain == 'ca1media.mobi') ) topDomain = 'denverpost.com';	//added only for dev, delete before live	//elpasotimes	//denverpost
				
				topDomain = 'denverpost.com';
				basedomain = 'www.denverpost.com';
				
				//js
				var url = 'props/'+ topDomain +'/prop.js';
				var script = document.createElement('script');script.setAttribute('src', url);script.setAttribute('id', 'propJS');script.setAttribute('type', 'text/javascript');
				document.getElementsByTagName('head')[0].appendChild(script);
				script.onload = script.onreadystatechange = function() {
					showInterface();
				};

				//css
				var url = 'props/'+ topDomain +'/prop.css';
				var fileref=document.createElement("link");fileref.setAttribute("rel", "stylesheet");fileref.setAttribute("type", "text/css");fileref.setAttribute("href", url)
				if (typeof fileref!="undefined") document.getElementsByTagName("head")[0].appendChild(fileref);
				//---------------------------------------------load property specific external files (end)
			}
			

			
			function showInterface() {
				//property data has now also loaded, we are ready to rock and roll
				
				//------init omniture
				handler.raiseEvent("init Omniture");
				
				//xInterface = new Interface( 'test', {transition: 'fade'});
				xInterface = new Interface( '' );	//this shows nothing but initiates the class

				//once interface is loaded we:
				//	1. load local content
				loadPropertyData();			//eventually once this is loading external content, it will need other things to wait until it is done
				
				//	2. build the sections menu window
				renderSectionsWindow();
				
				//prepareAds();
				
				if ( 0 ) {
					//
					setTimeout(function() { xInterface.showWindow( 'testWindow', {transition: 'fade'} ); }, 100);
					setTimeout(function() { prepareAllIframes('testWindow'); }, 1500);
					return;
				}
				
				//-----------------------------------------------------launch environment
				preloadimages([ 'props/'+ topDomain +'/'+ propertySplashImage ]).done(function(images){
					//when images are done loading:
					
					//-----------------show splash!
					var xString = '<div class="content" ><div class="splash" style="background-image:url(props/'+ topDomain +'/'+ propertySplashImage +');background-color:#'+ backgroundsplash +';"></div></div>'
					document.getElementById( 'splash' ).innerHTML = xString;
					setTimeout(function() { xInterface.showWindow( 'splash', {transition: 'fade'} ); }, 100);
					
					
					
					
					
					//-----------------set home logo on section front
					//document.getElementById( 'home_logo' ).innerHTML = '<img src="props/'+ topDomain +'/dpflag.svg" width="200" alt="Denver Logo" style="margin-top:5px;margin-left:-5px;"/>';
					ChangeStyleSheet('.flag', 'background', "url('../props/"+ topDomain +"/flag.svg') no-repeat 50%", 0);
					//background: url('assets/dpflag.svg') no-repeat 50%;
					
					//-----------------load sections
					DetermineWhatToDoNextFromURL();
					
					
					
					
					
					//setTimeout(function() { loadNewSection(); }, 1500);
					
					//alert(images.length) //alerts 3//alert(images[0].src+" "+images[0].width) //alerts '1.gif 220'
				});
				//http://extras.denverpost.com/media/MRSS/Breaking_News_230605.xml
				
				//----------------------add the app checker for iOS (should be moved to dfm_mobile and only run if iOS) 
				//<meta name="apple-itunes-app" content="app-id=375264133">
				var viewPortTag=document.createElement('meta');
				//viewPortTag.id="viewport";
				viewPortTag.name = "apple-itunes-app";
				viewPortTag.content = "app-id="+ AppleAppID;		//375264133
				document.getElementsByTagName('head')[0].appendChild(viewPortTag);
				//----------------------add the app checker for iOS (should be moved to dfm_mobile and only run if iOS) (END)
				
				
			}
			//xInterface.removeLoaderInWindow('home');//xInterface.putLoaderInWindow( 'home' );//
			
			//get_top_domain( 'http://www.denverpost.com/funstuff/fun.html' );
			//get_top_domain( 'http://denverpost.com/funstuff/fun.html' );
			//get_top_domain( 'denverpost.com/funstuff/fun.html' );
			//get_top_domain( 'broncos.denverpost.com/funstuff/fun.html' );
			
			//----MUST be on this page and not an external js
			function get_top_domain( xURL ){
				//get base domain denverpost.com
				xURL = get_base_domain( xURL );
				
				xURL = xURL.split(".");
				//console.debug('xURL2: '+ xURL.length );
				if (xURL.length > 2) {
					xURL = xURL[xURL.length - 2] + '.'+ xURL[xURL.length-1];
				} else {
					xURL = xURL[0] + '.'+ xURL[1];
				}
				
				//console.debug('xURL3: '+ xURL );
				return xURL;
			}
			
			function get_base_domain( xURL ) {
				//get base domain www.denverpost.com
				if (xURL.indexOf("//") !== -1) {
					xURL = xURL.split("/");
					xURL = xURL[2];
				} else {
					xURL = xURL.split("/");
					xURL = xURL[0];
				}
				//console.debug('get_base_domain: '+ xURL );
				return xURL;
			}
			
			//--------------OMNITURE EVENT HANDLER CODE JOSH D WROTE
			function eventHandler() {
			    this.events = [];
			    this.calls = [];
			    this.params = [];
			    this.registerEvent = function registerEvent(eventName) {
			        if (!this.events[eventName]) {
			            this.events[eventName] = [];
			            this.params[eventName] = []
			        }
			    }
			    this.raiseEvent = function(eventName) {
			        if (this.events[eventName]) {
			            for (var ct = 0; ct <= this.events[eventName].length - 1; ct++) {
			                this.events[eventName][ct](this.params[eventName][ct]);
			            }
			        }
			    }
			    this.attachEvent = function(eventName, funcCall, params) {
			        if (!this.events[eventName]) {
			            this.registerEvent(eventName)
			        }
			        this.events[eventName].push(funcCall);
			        this.params[eventName].push(params);
			    }
			    this.removeEvent = function(eventName, funcCall) {
			        if (this.events[eventName]) {
			            if (this.events[eventName]) {
			                var a = [];
			                var b = [];
			                for (var ct = 0; ct <= this.events[eventName].length - 1; ct++) {
			                    if (this.events[eventName][ct] != funcCall) {
			                        a.push(this.events[eventName][ct])
			                        b.push(this.params[eventName][ct])
			                    }
			                }
			            }
			            this.events[eventName] = a;
			            this.params[eventName] = b;
			        }
			    }
			}
			
			var handler = new eventHandler();
			handler.registerEvent("init Omniture");
			handler.registerEvent("page view");
			// call using handler.raiseEvent("page view");
			//--------------OMNITURE EVENT HANDLER CODE JOSH D WROTE (end)
			
			function prepareAllIframes(xDiv) {
				console.debug('prepareAllIframes' );
				var xcover = document.getElementById( 'iframeCover' );
				xcover.ontouchstart = function() {
					console.debug('ontouchstart');
					xActiveTouch = 1;
			    };
				xcover.ontouchmove = function(event) {
					//console.debug('ontouchmove: '+ event.touches[0].pageX);
					xActiveTouch = 0;
			    };
				xcover.ontouchend = function(event) {
					if (xActiveTouch) {
						if (event == null) { event = window.event }
						//this.style['pointer-events'] = "none";
						// Find click position (coordinates)
						var rect = document.getElementById( 'xwrapper' ).getBoundingClientRect();
						console.log(rect.top, rect.right, rect.bottom, rect.left);
						
						var x = event.changedTouches[0].pageX - rect.left;
						var y = event.changedTouches[0].pageY - rect.top;
						console.debug('its a click through!!! '+ x +', '+ y);
						
						//setTimeout(function() { fakeClick(event, document.getElementById('iframeX')) }, 500);
						
						
						//var touches = event.changedTouches, first = touches[0];
						
						//var iframe = document.getElementById( 'iframeX' );
						//document.getElementById( 'iframeX' ).dispatchEvent(event);
						
						/*
						//http://stackoverflow.com/questions/8058699/drag-drop-on-mobile-devices-using-some-code-that-translates-event-code-included
						var simulatedEvent = document.createEvent("MouseEvent");
						simulatedEvent.initMouseEvent("mouseup", true, true, window, 1, first.screenX, first.screenY, first.clientX, first.clientY, false, false, false, false, 0, null);
						first.target.dispatchEvent(simulatedEvent);
						*/
						
						//var evObj = document.createEvent('cClick');
						//evObj.initEvent(etype, true, false);
						//el.dispatchEvent(evObj);
						
						//return true;
						//pointer-events: none;
						
						
						var iframes = document.getElementById( 'xwrapper' ).getElementsByTagName('iframe');
						var iframe = iframes[0];
						var iframeDoc = (iframe.contentDocument) ? iframe.contentDocument : iframe.contentWindow.document;
						//console.debug('its a click through!!! '+ event.target.id);
						
						// Trigger click inside iframe
						var link = iframeDoc.elementFromPoint(x, y);
						var newEvent = iframeDoc.createEvent('HTMLEvents');
						newEvent.initEvent('click', true, true);
						link.dispatchEvent(newEvent);
						
					}
			    };
			}
			function fakeClick(event, anchorObj) {
			  if (anchorObj.click) {
			    anchorObj.click()
			  } else if(document.createEvent) {
			    if(event.target !== anchorObj) {
			      var evt = document.createEvent("MouseEvents"); 
			      evt.initMouseEvent("click", true, true, window, 
			          0, 0, 0, 0, 0, false, false, false, false, 0, null); 
			      var allowDefault = anchorObj.dispatchEvent(evt);
			      // you can check allowDefault for false to see if
			      // any handler called evt.preventDefault().
			      // Firefox will *not* redirect to anchorObj.href
			      // for you. However every other browser will.
			    }
			  }
			}
			
			
			function viewportCoordinateToDocumentCoordinate(x,y) {
			    var coord = new Object();
			    coord.x = x + window.pageXOffset;
			    coord.y = y + window.pageYOffset;
			    return coord;
			}
			function elementFromPointIsUsingViewPortCoordinates() {
			    if (window.pageYOffset > 0) {     // page scrolled down
			        return (window.document.elementFromPoint(0, window.pageYOffset + window.innerHeight -1) == null);
			    } else if (window.pageXOffset > 0) {   // page scrolled to the right
			        return (window.document.elementFromPoint(window.pageXOffset + window.innerWidth -1, 0) == null);
			    }
			    return false; // no scrolling, don't care
			}
			function elementFromDocumentPoint(x,y) {
			  if (elementFromPointIsUsingViewPortCoordinates()) {
			    var coord = documentCoordinateToViewportCoordinate(x,y);
			    return window.document.elementFromPoint(coord.x,coord.y);
			  } else {
			    return window.document.elementFromPoint(x,y);
			  }
			}
			function documentCoordinateToViewportCoordinate(x,y) {
			    var coord = new Object();
			    coord.x = x - window.pageXOffset;
			    coord.y = y - window.pageYOffset;
			    return coord;
			}
			function documentCoordinateToViewportCoordinate(x,y) {
			    var coord = new Object();
			    coord.x = x - window.pageXOffset;
			    coord.y = y - window.pageYOffset;
			    return coord;
			}
			function elementFromViewportPoint(x,y) {
			  if (elementFromPointIsUsingViewPortCoordinates()) {
			    return window.document.elementFromPoint(x,y);
			  } else {
			    var coord = viewportCoordinateToDocumentCoordinate(x,y);
			    return window.document.elementFromPoint(coord.x,coord.y);
			  }
			}
			
		</script>
		
		<!-- 
					how to set page title. Its important for SEO to have it the way we want it load from BACKEND...
						so php might need to be used afterall
		-->
		<title>Colorado Breaking News, Sports, Weather, Traffic - The Denver Post</title>
		
		<!-- 
		<script src="js/iscroll.js" type="text/javascript"></script>
		-->
		<script src="js/universal.js" type="text/javascript"></script>
	</head>
<body>

<div id="dfm_mobile" >
	
	<div id="testWindow" >
		<div class="content " style="background-color:#FFF;">
			<div  class="scroller " style="padding-top:60px;padding:0 1.5em;">Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum.
				<div id="xwrapper" style="width:180px;height:150px;overflow:hidden;">
					<div id="iframeCover" style="position:absolute;opacity:0;width:100%;height:100%;top:0;left:0;right:0;bottom:0;z-index:2;"></div>
					<iframe id="iframeX" src="temp/iframe.html" style="width:180px;height:150px;margin:0px;padding:0px;"></iframe>
				</div>
			Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. Duis aute irure dolor in reprehenderit in voluptate velit esse cillum dolore eu fugiat nulla pariatur. Excepteur sint occaecat cupidatat non proident, sunt in culpa qui officia deserunt mollit anim id est laborum. Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua.	
			</div>
		</div>
	</div><!-- /splash -->
	
	<div id="splash" >
		<div class="content" >
			<div class="splash"  style=""></div>
		</div>
	</div><!-- /splash -->
	
	<div id="home" >
		<div class="toolbar darkblue">
			<!-- ALL buttons first -->
			<div class="sm_but_icon sections" onclick="xInterface.showWindow( 'sections_window', { transition: 'slideRight', overlay:1 });">
				<span class="icon-bar"></span>
		        <span class="icon-bar"></span>
		        <span class="icon-bar"></span>
			</div>
			<div class="sm_but_icon settings right" onclick="xInterface.showWindow( 'settings_window', { transition: 'fade', overlay:1 });"></div>
			
			<!-- then add title -->
			<h4 class="flag"></h4>
		</div>
		<div class="content belowtoolbar " style="background-color:#333;">
			<div id="home_section_list" class="scroller full custom"></div>
		</div>
	</div><!-- /home -->
	
	
	<div id="story_window" >
		<div class="content " style="background-color:#FFF;">
			<div id="story_container" class="scroller ">
				<div id="story_ad_top" >
					<script type='text/javascript'>
						googletag.cmd.push(function() { googletag.display('story_ad_top')});
					</script>
				</div>
				<div id="story_ad_bottom" >
					<script type='text/javascript'>
						googletag.cmd.push(function() { googletag.display('story_ad_bottom')});
					</script>
				</div>
			</div>
		</div>
	</div><!-- /story_window -->
	
	<div id="gallery_window" >
		<div class="content " style="background-color:#000;">
			<div id="story_container" class="scroller "></div>
		</div>
	</div><!-- /gallery_window -->
	
	
	<div id="share_window">
		<div class="content alertwindow overlay" style="">
			<div class="close" onclick="xInterface.closeActiveWindow();"><img src="css/close_pop.png" class="btn_close" title="Close Window" style="float: right;margin: -10px -10px 0 0;" /></div>
			<div style="position:absolute;top:20px;left:20px;right:20px;margin:auto;text-align:center;border:1px solid #333;">
				<div style="position:relative;margin:10px;width:200px;display:inline-block;"  ontouchstart="xActiveTouch = 1;" ontouchmove="xActiveTouch = 0;" onclick="event.returnValue=false;if (xActiveTouch) { alert('234'); }">
					<div class="list_image_title" style="margin:5px 0px 0px 0px;width:100%;color:#333;">Sharing alert window will contain buttons for social sharing sites such as Facebook and twitter.</div>
				</div>
			</div>
		</div>
	</div><!-- /share_window -->
	
	<div id="sections_window" style="width:300px;">
			<div class="toolbar invisible" >
				<!-- ALL buttons first -->
				<div class="sm_but_icon sections active"  onclick="xInterface.closeActiveWindow();"><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></div>
				<!-- then add title -->
				<h4 class="flag">The Denver Post</h4>
			</div>
			<div class="content belowtoolbar black overlay" style="">
				<div id="sections_container" class="scroller full dark" style="border-right:1px solid #000;"></div>
			</div>

	</div><!-- /sections_window -->
	
	<div id="settings_window">
		<div class="content alertwindow overlay" style="">
			<div class="close" onclick="xInterface.closeActiveWindow();"><img src="css/close_pop.png" class="btn_close" title="Close Window" style="float: right;margin: -10px -10px 0 0;" /></div>
			<div style="position:absolute;top:20px;left:20px;right:20px;margin:auto;text-align:center;border:1px solid #333;">
				<div style="position:relative;margin:10px;width:200px;display:inline-block;"  ontouchstart="xActiveTouch = 1;" ontouchmove="xActiveTouch = 0;" onclick="event.returnValue=false;if (xActiveTouch) { alert('234'); }">
					<div class="list_image_title" style="margin:5px 0px 0px 0px;width:100%;color:#333;">Settings window will contain features such as 'View Desktop Version', change article text size, etc.</div>
				</div>
			</div>
		</div>
	</div><!-- /settings_window -->
	
	
</div><!-- /dfm_mobile -->

</body>
</html>
